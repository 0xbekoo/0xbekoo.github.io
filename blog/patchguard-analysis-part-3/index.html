<!DOCTYPE html>
<html lang="en"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon shortcut" href="/favicon.ico" sizes="32x32" />
<link rel="icon" href="/favicon.svg" type="image/svg+xml" />
<link rel="icon" href="/favicon-dark.svg" type="image/svg+xml" media="(prefers-color-scheme: dark)" />
<link rel="icon" href="/favicon-16x16.png" type="image/png" sizes="16x16" />
<link rel="icon" href="/favicon-32x32.png" type="image/png" sizes="32x32" />
<link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180" />
<link fetchpriority="low" href="/site.webmanifest" rel="manifest" />
<title>PatchGuard Analysis - Part 3 â€“ 0xbekoo</title>
  <meta name="description" content="Triggering a check As we have seen before, the several methods used to setup some contexts. In this section, we will see that how these contexts are triggered.
DPC Execution The frequently way to trigger a check is to use a DPC. The routine set as DeferredRoutine are picked among the following:
0 CmpEnableLazyFlushDpcRoutine 1 ExpCenturyDpcRoutine 2 ExpTimeZoneDpcRoutine 3 ExpTimeRefreshDpcRoutine 4 CmpLazyFlushDpcRoutine 5 ExpTimerDpcRoutine 6 IopTimerDispatch 7 IopIrpStackProfilerDpcRoutine 8 KiBalanceSetManagerDeferredRoutine 9 PopThermalZoneDpc 10 KiTimerDispatch OR KiDpcDispatch 11 KiTimerDispatch OR KiDpcDispatch 12 KiTimerDispatch OR KiDpcDispatch Among index 0 to 9, functions use an exception handler to fire the check. KiTimerDispatch and KiDpcDispatch functions call the DPC directly without any exception handler. In other words, these functions do their job while PatchGuard hijacks them to hiding itself." /><link rel="canonical" href="http://localhost:1313/blog/patchguard-analysis-part-3/" itemprop="url" />

<meta property="og:title" content="PatchGuard Analysis - Part 3" />
<meta property="og:description" content="Triggering a check
    As we have seen before, the several methods used to setup some contexts. In this section, we will see that how these contexts are triggered.
DPC Execution
    The frequently way to trigger a check is to use a DPC. The routine set as DeferredRoutine are picked among the following:

  
      
          0
          CmpEnableLazyFlushDpcRoutine
      
  
  
      
          1
          ExpCenturyDpcRoutine
      
      
          2
          ExpTimeZoneDpcRoutine
      
      
          3
          ExpTimeRefreshDpcRoutine
      
      
          4
          CmpLazyFlushDpcRoutine
      
      
          5
          ExpTimerDpcRoutine
      
      
          6
          IopTimerDispatch
      
      
          7
          IopIrpStackProfilerDpcRoutine
      
      
          8
          KiBalanceSetManagerDeferredRoutine
      
      
          9
          PopThermalZoneDpc
      
      
          10
          KiTimerDispatch OR KiDpcDispatch
      
      
          11
          KiTimerDispatch OR KiDpcDispatch
      
      
          12
          KiTimerDispatch OR KiDpcDispatch
      
  

Among index 0 to 9, functions use an exception handler to fire the check. KiTimerDispatch and KiDpcDispatch functions call the DPC directly without any exception handler. In other words, these functions do their job while PatchGuard hijacks them to hiding itself." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/blog/patchguard-analysis-part-3/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2025-08-08T00:00:00+00:00" />
<meta property="article:modified_time" content="2025-08-16T00:35:41+03:00" />

  <meta itemprop="name" content="PatchGuard Analysis - Part 3">
  <meta itemprop="description" content="Triggering a check As we have seen before, the several methods used to setup some contexts. In this section, we will see that how these contexts are triggered.
DPC Execution The frequently way to trigger a check is to use a DPC. The routine set as DeferredRoutine are picked among the following:
0 CmpEnableLazyFlushDpcRoutine 1 ExpCenturyDpcRoutine 2 ExpTimeZoneDpcRoutine 3 ExpTimeRefreshDpcRoutine 4 CmpLazyFlushDpcRoutine 5 ExpTimerDpcRoutine 6 IopTimerDispatch 7 IopIrpStackProfilerDpcRoutine 8 KiBalanceSetManagerDeferredRoutine 9 PopThermalZoneDpc 10 KiTimerDispatch OR KiDpcDispatch 11 KiTimerDispatch OR KiDpcDispatch 12 KiTimerDispatch OR KiDpcDispatch Among index 0 to 9, functions use an exception handler to fire the check. KiTimerDispatch and KiDpcDispatch functions call the DPC directly without any exception handler. In other words, these functions do their job while PatchGuard hijacks them to hiding itself.">
  <meta itemprop="datePublished" content="2025-08-08T00:00:00+00:00">
  <meta itemprop="dateModified" content="2025-08-16T00:35:41+03:00">
  <meta itemprop="wordCount" content="2531">
  <meta itemprop="keywords" content="Reverse-Engineering,PatchGuard,Reversing-PatchGuard,Windows-Internals,Analyzing-of-Windows-Kernel">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="PatchGuard Analysis - Part 3">
  <meta name="twitter:description" content="Triggering a check As we have seen before, the several methods used to setup some contexts. In this section, we will see that how these contexts are triggered.
DPC Execution The frequently way to trigger a check is to use a DPC. The routine set as DeferredRoutine are picked among the following:
0 CmpEnableLazyFlushDpcRoutine 1 ExpCenturyDpcRoutine 2 ExpTimeZoneDpcRoutine 3 ExpTimeRefreshDpcRoutine 4 CmpLazyFlushDpcRoutine 5 ExpTimerDpcRoutine 6 IopTimerDispatch 7 IopIrpStackProfilerDpcRoutine 8 KiBalanceSetManagerDeferredRoutine 9 PopThermalZoneDpc 10 KiTimerDispatch OR KiDpcDispatch 11 KiTimerDispatch OR KiDpcDispatch 12 KiTimerDispatch OR KiDpcDispatch Among index 0 to 9, functions use an exception handler to fire the check. KiTimerDispatch and KiDpcDispatch functions call the DPC directly without any exception handler. In other words, these functions do their job while PatchGuard hijacks them to hiding itself.">

    <link href="/css/compiled/main.css" rel="stylesheet" />



  <link href="/css/custom.css" rel="stylesheet" />


  <script>
     
    const defaultTheme = 'system';

    const setDarkTheme = () => {
      document.documentElement.classList.add("dark");
      document.documentElement.style.colorScheme = "dark";
    }
    const setLightTheme = () => {
      document.documentElement.classList.remove("dark");
      document.documentElement.style.colorScheme = "light";
    }

    if ("color-theme" in localStorage) {
      localStorage.getItem("color-theme") === "dark" ? setDarkTheme() : setLightTheme();
    } else {
      defaultTheme === "dark" ? setDarkTheme() : setLightTheme();
      if (defaultTheme === "system") {
        window.matchMedia("(prefers-color-scheme: dark)").matches ? setDarkTheme() : setLightTheme();
      }
    }
  </script>

  
</head>
<body dir="ltr"><div class="nav-container hx-sticky hx-top-0 hx-z-20 hx-w-full hx-bg-transparent print:hx-hidden">
  <div class="nav-container-blur hx-pointer-events-none hx-absolute hx-z-[-1] hx-h-full hx-w-full hx-bg-white dark:hx-bg-dark hx-shadow-[0_2px_4px_rgba(0,0,0,.02),0_1px_0_rgba(0,0,0,.06)] contrast-more:hx-shadow-[0_0_0_1px_#000] dark:hx-shadow-[0_-1px_0_rgba(255,255,255,.1)_inset] contrast-more:dark:hx-shadow-[0_0_0_1px_#fff]"></div>

  <nav class="hx-mx-auto hx-flex hx-items-center hx-justify-end hx-gap-2 hx-h-16 hx-px-6 hx-max-w-[90rem]">
    <a class="hx-flex hx-items-center hover:hx-opacity-75 ltr:hx-mr-auto rtl:hx-ml-auto" href="/">
        <span class="hx-mx-2 hx-font-extrabold hx-inline hx-select-none" title="0xbekoo">0xbekoo</span>
    </a><a
            title="Documentation"
            href="/docs"
            
            class="hx-text-sm contrast-more:hx-text-gray-700 contrast-more:dark:hx-text-gray-100 hx-relative -hx-ml-2 hx-hidden hx-whitespace-nowrap hx-p-2 md:hx-inline-block hx-text-gray-600 hover:hx-text-gray-800 dark:hx-text-gray-400 dark:hover:hx-text-gray-200"
          >
            <span class="hx-text-center">Documentation</span>
          </a><a
            title="Blogs"
            href="/blog"
            
            class="hx-text-sm contrast-more:hx-text-gray-700 contrast-more:dark:hx-text-gray-100 hx-relative -hx-ml-2 hx-hidden hx-whitespace-nowrap hx-p-2 md:hx-inline-block hx-font-medium"
          >
            <span class="hx-text-center">Blogs</span>
          </a><a
            title="About"
            href="/about"
            
            class="hx-text-sm contrast-more:hx-text-gray-700 contrast-more:dark:hx-text-gray-100 hx-relative -hx-ml-2 hx-hidden hx-whitespace-nowrap hx-p-2 md:hx-inline-block hx-text-gray-600 hover:hx-text-gray-800 dark:hx-text-gray-400 dark:hover:hx-text-gray-200"
          >
            <span class="hx-text-center">About</span>
          </a>
          <a class="hx-p-2 hx-text-current" target="_blank" rel="noreferrer" href="https://github.com/0xbekoo" title="GitHub"><svg height=24 fill="currentColor" viewBox="3 3 18 18">
  <path d="M12 3C7.0275 3 3 7.12937 3 12.2276C3 16.3109 5.57625 19.7597 9.15374 20.9824C9.60374 21.0631 9.77249 20.7863 9.77249 20.5441C9.77249 20.3249 9.76125 19.5982 9.76125 18.8254C7.5 19.2522 6.915 18.2602 6.735 17.7412C6.63375 17.4759 6.19499 16.6569 5.8125 16.4378C5.4975 16.2647 5.0475 15.838 5.80124 15.8264C6.51 15.8149 7.01625 16.4954 7.18499 16.7723C7.99499 18.1679 9.28875 17.7758 9.80625 17.5335C9.885 16.9337 10.1212 16.53 10.38 16.2993C8.3775 16.0687 6.285 15.2728 6.285 11.7432C6.285 10.7397 6.63375 9.9092 7.20749 9.26326C7.1175 9.03257 6.8025 8.08674 7.2975 6.81794C7.2975 6.81794 8.05125 6.57571 9.77249 7.76377C10.4925 7.55615 11.2575 7.45234 12.0225 7.45234C12.7875 7.45234 13.5525 7.55615 14.2725 7.76377C15.9937 6.56418 16.7475 6.81794 16.7475 6.81794C17.2424 8.08674 16.9275 9.03257 16.8375 9.26326C17.4113 9.9092 17.76 10.7281 17.76 11.7432C17.76 15.2843 15.6563 16.0687 13.6537 16.2993C13.98 16.5877 14.2613 17.1414 14.2613 18.0065C14.2613 19.2407 14.25 20.2326 14.25 20.5441C14.25 20.7863 14.4188 21.0746 14.8688 20.9824C16.6554 20.364 18.2079 19.1866 19.3078 17.6162C20.4077 16.0457 20.9995 14.1611 21 12.2276C21 7.12937 16.9725 3 12 3Z"></path>
</svg>
<span class="hx-sr-only">GitHub</span>
          </a>
          <a class="hx-p-2 hx-text-current" target="_blank" rel="noreferrer" href="https://x.com/0xbekooo" title="Twitter"><svg height=24 xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"></path></svg><span class="hx-sr-only">Twitter</span>
          </a><button type="button" aria-label="Menu" class="hamburger-menu -hx-mr-2 hx-rounded hx-p-2 active:hx-bg-gray-400/20 md:hx-hidden"><svg height=24 fill="none" viewBox="0 0 24 24" stroke="currentColor"><g><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8H20"></path></g><g><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16H20"></path></g></svg></button>
  </nav>
</div>

  <div class="hx-mx-auto hx-flex hx-max-w-screen-xl">
    <div class="mobile-menu-overlay [transition:background-color_1.5s_ease] hx-fixed hx-inset-0 hx-z-10 hx-bg-black/80 dark:hx-bg-black/60 hx-hidden"></div>
<aside class="sidebar-container hx-flex hx-flex-col print:hx-hidden md:hx-top-16 md:hx-shrink-0 md:hx-w-64 md:hx-self-start max-md:[transform:translate3d(0,-100%,0)] md:hx-hidden xl:hx-block">
  
  <div class="hx-px-4 hx-pt-4 md:hx-hidden">
    <div class="search-wrapper hx-relative md:hx-w-64">
  <div class="hx-relative hx-flex hx-items-center hx-text-gray-900 contrast-more:hx-text-gray-800 dark:hx-text-gray-300 contrast-more:dark:hx-text-gray-300">
    <input
      placeholder="Search..."
      class="search-input hx-block hx-w-full hx-appearance-none hx-rounded-lg hx-px-3 hx-py-2 hx-transition-colors hx-text-base hx-leading-tight md:hx-text-sm hx-bg-black/[.05] dark:hx-bg-gray-50/10 focus:hx-bg-white dark:focus:hx-bg-dark placeholder:hx-text-gray-500 dark:placeholder:hx-text-gray-400 contrast-more:hx-border contrast-more:hx-border-current"
      type="search"
      value=""
      spellcheck="false"
    />
    <kbd
      class="hx-absolute hx-my-1.5 hx-select-none ltr:hx-right-1.5 rtl:hx-left-1.5 hx-h-5 hx-rounded hx-bg-white hx-px-1.5 hx-font-mono hx-text-[10px] hx-font-medium hx-text-gray-500 hx-border dark:hx-border-gray-100/20 dark:hx-bg-dark/50 contrast-more:hx-border-current contrast-more:hx-text-current contrast-more:dark:hx-border-current hx-items-center hx-gap-1 hx-transition-opacity hx-pointer-events-none hx-hidden sm:hx-flex"
    >
      CTRL K
    </kbd>
  </div>

  <div>
    <ul
      class="search-results hextra-scrollbar hx-hidden hx-border hx-border-gray-200 hx-bg-white hx-text-gray-100 dark:hx-border-neutral-800 dark:hx-bg-neutral-900 hx-absolute hx-top-full hx-z-20 hx-mt-2 hx-overflow-auto hx-overscroll-contain hx-rounded-xl hx-py-2.5 hx-shadow-xl hx-max-h-[min(calc(50vh-11rem-env(safe-area-inset-bottom)),400px)] md:hx-max-h-[min(calc(100vh-5rem-env(safe-area-inset-bottom)),400px)] hx-inset-x-0 ltr:md:hx-left-auto rtl:md:hx-right-auto contrast-more:hx-border contrast-more:hx-border-gray-900 contrast-more:dark:hx-border-gray-50 hx-w-screen hx-min-h-[100px] hx-max-w-[min(calc(100vw-2rem),calc(100%+20rem))]"
      style="transition: max-height 0.2s ease 0s;"
    ></ul>
  </div>
</div>

  </div>
  <div class="hextra-scrollbar hx-overflow-y-auto hx-overflow-x-hidden hx-p-4 hx-grow md:hx-h-[calc(100vh-var(--navbar-height)-var(--menu-height))]">
    <ul class="hx-flex hx-flex-col hx-gap-1 md:hx-hidden">
      
      
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/about/"
    
  >About
    </a></li>
          <li class="open"><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/blog/"
    
  >Blogs
        <span class="hextra-sidebar-collapsible-button"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" class="hx-h-[18px] hx-min-w-[18px] hx-rounded-sm hx-p-0.5 hover:hx-bg-gray-800/5 dark:hover:hx-bg-gray-100/5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" class="hx-origin-center hx-transition-transform rtl:-hx-rotate-180"></path></svg></span>
    </a><div class="ltr:hx-pr-0 hx-overflow-hidden">
        <ul class='hx-relative hx-flex hx-flex-col hx-gap-1 before:hx-absolute before:hx-inset-y-1 before:hx-w-px before:hx-bg-gray-200 before:hx-content-[""] ltr:hx-ml-3 ltr:hx-pl-3 ltr:before:hx-left-0 rtl:hx-mr-3 rtl:hx-pr-3 rtl:before:hx-right-0 dark:before:hx-bg-neutral-800'><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/blog/patchguard-analysis-part-4/"
    
  >PatchGuard Analysis - Part 4
    </a>
              
            </li><li class="hx-flex hx-flex-col open"><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      sidebar-active-item hx-bg-primary-100 hx-font-semibold hx-text-primary-800 contrast-more:hx-border contrast-more:hx-border-primary-500 dark:hx-bg-primary-400/10 dark:hx-text-primary-600 contrast-more:dark:hx-border-primary-500"
    href="/blog/patchguard-analysis-part-3/"
    
  >PatchGuard Analysis - Part 3
    </a>
  
    <ul class='hx-flex hx-flex-col hx-gap-1 hx-relative before:hx-absolute before:hx-inset-y-1 before:hx-w-px before:hx-bg-gray-200 before:hx-content-[""] dark:before:hx-bg-neutral-800 ltr:hx-pl-3 ltr:before:hx-left-0 rtl:hx-pr-3 rtl:before:hx-right-0 ltr:hx-ml-3 rtl:hx-mr-3'><li>
              <a
                href="#"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              ></a>
            </li>
          </ul>
  
              
            </li><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/blog/patchguard-analysis-part-2/"
    
  >PatchGuard Analysis - Part 2
    </a>
              
            </li><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/blog/ssdt-hooking/"
    
  >Loading Driver from User-Mode Program via SSDT Hooking
    </a>
              
            </li><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/blog/syscalls/"
    
  >Reversing System Call Mechanism in Windows Kernel
    </a>
              
            </li><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/blog/bare-metal-reversing/"
    
  >ARM Firmware Reverse Engineering
    </a>
              
            </li><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/blog/router-firmware-reversing/"
    
  >Router Firmware Reverse Engineering
    </a>
              
            </li><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/blog/is-valorant-spyware/"
    
  >Is Valorant Spyware?
    </a>
              
            </li></ul>
      </div></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/"
    
  >Documentation
        <span class="hextra-sidebar-collapsible-button"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" class="hx-h-[18px] hx-min-w-[18px] hx-rounded-sm hx-p-0.5 hover:hx-bg-gray-800/5 dark:hover:hx-bg-gray-100/5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" class="hx-origin-center hx-transition-transform rtl:-hx-rotate-180"></path></svg></span>
    </a><div class="ltr:hx-pr-0 hx-overflow-hidden">
        <ul class='hx-relative hx-flex hx-flex-col hx-gap-1 before:hx-absolute before:hx-inset-y-1 before:hx-w-px before:hx-bg-gray-200 before:hx-content-[""] ltr:hx-ml-3 ltr:hx-pl-3 ltr:before:hx-left-0 rtl:hx-mr-3 rtl:hx-pr-3 rtl:before:hx-right-0 dark:before:hx-bg-neutral-800'><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/uefi-dev/"
    
  >UEFI Development
        <span class="hextra-sidebar-collapsible-button"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" class="hx-h-[18px] hx-min-w-[18px] hx-rounded-sm hx-p-0.5 hover:hx-bg-gray-800/5 dark:hover:hx-bg-gray-100/5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" class="hx-origin-center hx-transition-transform rtl:-hx-rotate-180"></path></svg></span>
    </a>
              <div class="ltr:hx-pr-0 hx-overflow-hidden">
        <ul class='hx-relative hx-flex hx-flex-col hx-gap-1 before:hx-absolute before:hx-inset-y-1 before:hx-w-px before:hx-bg-gray-200 before:hx-content-[""] ltr:hx-ml-3 ltr:hx-pl-3 ltr:before:hx-left-0 rtl:hx-mr-3 rtl:hx-pr-3 rtl:before:hx-right-0 dark:before:hx-bg-neutral-800'><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/uefi-dev/communation-between-windows-and-uefi/"
    
  >UEFI to Windows Communication via NVRAM Variables
    </a>
              
            </li><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/uefi-dev/uefi-keylogger/"
    
  >UEFI Keylogger
    </a>
              
            </li><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/uefi-dev/uefi-introduction/"
    
  >Introduction to UEFI
    </a>
              
            </li></ul>
      </div>
            </li><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/malware-dev/"
    
  >Malware Development
        <span class="hextra-sidebar-collapsible-button"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" class="hx-h-[18px] hx-min-w-[18px] hx-rounded-sm hx-p-0.5 hover:hx-bg-gray-800/5 dark:hover:hx-bg-gray-100/5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" class="hx-origin-center hx-transition-transform rtl:-hx-rotate-180"></path></svg></span>
    </a>
              <div class="ltr:hx-pr-0 hx-overflow-hidden">
        <ul class='hx-relative hx-flex hx-flex-col hx-gap-1 before:hx-absolute before:hx-inset-y-1 before:hx-w-px before:hx-bg-gray-200 before:hx-content-[""] ltr:hx-ml-3 ltr:hx-pl-3 ltr:before:hx-left-0 rtl:hx-mr-3 rtl:hx-pr-3 rtl:before:hx-right-0 dark:before:hx-bg-neutral-800'><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/malware-dev/malware-resurrection/"
    
  >Malware Resurrection
    </a>
              
            </li><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/malware-dev/file-icon-spoofing/"
    
  >PDF Icon File Spoofing
    </a>
              
            </li><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/malware-dev/api-hashing/"
    
  >API Hashing
    </a>
              
            </li><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/malware-dev/direct-syscalls/"
    
  >Direct Syscalls
    </a>
              
            </li><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/malware-dev/ntapi-injection/"
    
  >NTAPI Injection
    </a>
              
            </li><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/malware-dev/dll-injection/"
    
  >DLL Injection
    </a>
              
            </li><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/malware-dev/shellcode-injection/"
    
  >Shellcode Injection
    </a>
              
            </li></ul>
      </div>
            </li><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/winkernel-dev/"
    
  >Windows Kernel Dev.
        <span class="hextra-sidebar-collapsible-button"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" class="hx-h-[18px] hx-min-w-[18px] hx-rounded-sm hx-p-0.5 hover:hx-bg-gray-800/5 dark:hover:hx-bg-gray-100/5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" class="hx-origin-center hx-transition-transform rtl:-hx-rotate-180"></path></svg></span>
    </a>
              <div class="ltr:hx-pr-0 hx-overflow-hidden">
        <ul class='hx-relative hx-flex hx-flex-col hx-gap-1 before:hx-absolute before:hx-inset-y-1 before:hx-w-px before:hx-bg-gray-200 before:hx-content-[""] ltr:hx-ml-3 ltr:hx-pl-3 ltr:before:hx-left-0 rtl:hx-mr-3 rtl:hx-pr-3 rtl:before:hx-right-0 dark:before:hx-bg-neutral-800'><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/winkernel-dev/wkd-dpc/"
    
  >DPC
    </a>
              
            </li><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/winkernel-dev/wkd-ssdt/"
    
  >SSDT
    </a>
              
            </li><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/winkernel-dev/wkd-virtual-memory/"
    
  >Virtual Memory
    </a>
              
            </li><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/winkernel-dev/wkd-ioctl/"
    
  >IOCTL
    </a>
              
            </li><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/winkernel-dev/wkd-irp/"
    
  >IRP
    </a>
              
            </li></ul>
      </div>
            </li></ul>
      </div></li>
      <li class="[word-break:break-word] hx-mt-5 hx-mb-2 hx-px-2 hx-py-1.5 hx-text-sm hx-font-semibold hx-text-gray-900 first:hx-mt-0 dark:hx-text-gray-100">
        <span class="hx-cursor-default">More</span>
      </li>
    
      <li><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/about/"
    
  >About</a></li>
    
    </ul>

    <div class="max-xl:hx-hidden hx-h-0 hx-w-64 hx-shrink-0"></div></div>
  
  
    <div class="md:hx-hidden hx-justify-end hx-sticky hx-bottom-0 hx-bg-white dark:hx-bg-dark hx-mx-4 hx-py-4 hx-shadow-[0_-12px_16px_#fff] hx-flex hx-items-center hx-gap-2 dark:hx-border-neutral-800 dark:hx-shadow-[0_-12px_16px_#111] contrast-more:hx-border-neutral-400 contrast-more:hx-shadow-none contrast-more:dark:hx-shadow-none hx-border-t" data-toggle-animation="show"><div class="hx-flex hx-justify-items-start hx-grow">
    <button
      title="Change language"
      data-state="closed"
      class="language-switcher hx-h-7 hx-rounded-md hx-px-2 hx-text-left hx-text-xs hx-font-medium hx-text-gray-600 hx-transition-colors dark:hx-text-gray-400 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 hx-grow"
      type="button"
      aria-label="Change language"
    >
      <div class="hx-flex hx-items-center hx-gap-2 hx-capitalize"><svg height=12 xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/></svg><span>English</span></div>
    </button>
    <ul
      class="language-options hx-hidden hx-z-20 hx-max-h-64 hx-overflow-auto hx-rounded-md hx-ring-1 hx-ring-black/5 hx-bg-white hx-py-1 hx-text-sm hx-shadow-lg dark:hx-ring-white/20 dark:hx-bg-neutral-800"
      style="position: fixed; inset: auto auto 0px 0px; margin: 0px; min-width: 100px;"
    >
      
        
        <li class="hx-flex hx-flex-col">
          <a
            href="/blog/patchguard-analysis-part-3/"
            class="hx-text-gray-800 dark:hx-text-gray-100 hover:hx-bg-primary-50 hover:hx-text-primary-600 hover:dark:hx-bg-primary-500/10 hover:dark:hx-text-primary-600 hx-relative hx-cursor-pointer hx-whitespace-nowrap hx-py-1.5 hx-transition-colors ltr:hx-pl-3 ltr:hx-pr-9 rtl:hx-pr-3 rtl:hx-pl-9"
          >English<span class="hx-absolute hx-inset-y-0 hx-flex hx-items-center ltr:hx-right-3 rtl:hx-left-3"><svg height=1em width=1em xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg></span></a>
        </li>
      
        
        <li class="hx-flex hx-flex-col">
          <a
            href="/tr/blog/patchguard-analysis-part-3/"
            class="hx-text-gray-800 dark:hx-text-gray-100 hover:hx-bg-primary-50 hover:hx-text-primary-600 hover:dark:hx-bg-primary-500/10 hover:dark:hx-text-primary-600 hx-relative hx-cursor-pointer hx-whitespace-nowrap hx-py-1.5 hx-transition-colors ltr:hx-pl-3 ltr:hx-pr-9 rtl:hx-pr-3 rtl:hx-pl-9"
          >Turkish</a>
        </li>
      </ul>
  </div><button
  title="Change theme"
  data-theme="light"
  class="theme-toggle hx-group hx-h-7 hx-rounded-md hx-px-2 hx-text-left hx-text-xs hx-font-medium hx-text-gray-600 hx-transition-colors dark:hx-text-gray-400 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50"
  type="button"
  aria-label="Change theme"
>
  <div class="hx-flex hx-items-center hx-gap-2 hx-capitalize"><svg height=12 class="group-data-[theme=light]:hx-hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg><svg height=12 class="group-data-[theme=dark]:hx-hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg></div>
</button>
</div></aside>
    
<nav class="hextra-toc hx-order-last hx-hidden hx-w-64 hx-shrink-0 xl:hx-block print:hx-hidden hx-px-4" aria-label="table of contents">
    <div class="hextra-scrollbar hx-sticky hx-top-16 hx-overflow-y-auto hx-pr-4 hx-pt-6 hx-text-sm [hyphens:auto] hx-max-h-[calc(100vh-var(--navbar-height)-env(safe-area-inset-bottom))] ltr:hx--mr-4 rtl:hx--ml-4"><p class="hx-mb-4 hx-font-semibold hx-tracking-tight">On this page</p><ul>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#triggering-a-check">Triggering a check
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-12 rtl:hx-pr-12 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#dpc-execution">DPC Execution
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#non-canonical-deferredcontext-pointer">Non-Canonical DeferredContext Pointer
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#triggering-the-exception-handler">Triggering the Exception Handler
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#patchguard-context-decryption">PatchGuard Context Decryption
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#passing-control-to-verification-routine">Passing Control to Verification Routine
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-12 rtl:hx-pr-12 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#system-thread-method">System Thread Method
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#triggering-the-exception-handler-1">Triggering the Exception Handler
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#creating-new-thread">Creating New Thread
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#the-decryption-process">The Decryption Process
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#post-verification-for-this-case-only">Post verification for this case only
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-12 rtl:hx-pr-12 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#apc-insertion">APC insertion
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-12 rtl:hx-pr-12 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#kiswinterruptdispatch-method">KiSwInterruptDispatch Method
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-12 rtl:hx-pr-12 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#breadcrumbs">Breadcrumbs
        </a>
      </li></ul>
      <div class="hx-mt-8 hx-border-t hx-bg-white hx-pt-8 hx-shadow-[0_-12px_16px_white] dark:hx-bg-dark dark:hx-shadow-[0_-12px_16px_#111] hx-sticky hx-bottom-0 hx-flex hx-flex-col hx-items-start hx-gap-2 hx-pb-8 dark:hx-border-neutral-800 contrast-more:hx-border-t contrast-more:hx-border-neutral-400 contrast-more:hx-shadow-none contrast-more:dark:hx-border-neutral-400">
        <button aria-hidden="true" id="backToTop" onClick="scrollUp();" class="hx-transition-all hx-duration-75 hx-opacity-0 hx-text-xs hx-font-medium hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-100 contrast-more:hx-text-gray-800 contrast-more:dark:hx-text-gray-50">
          <span>Scroll to top</span>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="hx-inline ltr:hx-ml-1 rtl:hx-mr-1 hx-h-3.5 hx-w-3.5 hx-border hx-rounded-full hx-border-gray-500 hover:hx-border-gray-900 dark:hx-border-gray-400 dark:hover:hx-border-gray-100 contrast-more:hx-border-gray-800 contrast-more:dark:hx-border-gray-50">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" />
          </svg>
        </button>
      </div>
    </div>
  </nav>


    <article class="hx-w-full hx-break-words hx-flex hx-min-h-[calc(100vh-var(--navbar-height))] hx-min-w-0 hx-justify-center hx-pb-8 hx-pr-[calc(env(safe-area-inset-right)-1.5rem)]">
      <main class="hx-w-full hx-min-w-0 hx-max-w-6xl hx-px-6 hx-pt-4 md:hx-px-12">
        
  <div class="hx-mt-1.5 hx-flex hx-items-center hx-gap-1 hx-overflow-hidden hx-text-sm hx-text-gray-500 dark:hx-text-gray-400 contrast-more:hx-text-current">
        <div class="hx-whitespace-nowrap hx-transition-colors hx-min-w-[24px] hx-overflow-hidden hx-text-ellipsis hover:hx-text-gray-900 dark:hover:hx-text-gray-100">
          <a href="/blog/">Blogs</a>
        </div><svg class="hx-w-3.5 hx-shrink-0 rtl:-hx-rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg><div class="hx-whitespace-nowrap hx-transition-colors hx-font-medium hx-text-gray-700 contrast-more:hx-font-bold contrast-more:hx-text-current dark:hx-text-gray-100 contrast-more:dark:hx-text-current">PatchGuard Analysis - Part 3</div>
  </div>

        <h1 class="hx-mt-2 hx-text-4xl hx-font-bold hx-tracking-tight hx-text-slate-900 dark:hx-text-slate-100">PatchGuard Analysis - Part 3</h1>
        <div class="hx-mt-4 hx-mb-16 hx-text-gray-500 hx-text-sm hx-flex hx-items-center hx-flex-wrap hx-gap-y-2"><span class="hx-mr-1">August 8, 2025</span><span class="hx-mx-1">Â·</span><a
                  href="https://github.com/0xbekoo" target="_blank"
                  class="hx-group hx-inline-flex hx-items-center hx-text-current hx-gap-x-1.5 hx-mx-1"
                  title="0xbekoo"
                ><img src="https://github.com/0xbekoo.png" alt="0xbekoo" class="hx-inline-block hx-h-4 hx-w-4 hx-rounded-full" loading="lazy" />
                  <div class="group-hover:hx-underline">0xbekoo</div>
                </a></div>
        <div class="content">
          <h4><strong>Triggering a check</strong><span class="hx-absolute -hx-mt-20" id="triggering-a-check"></span>
    <a href="#triggering-a-check" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>As we have seen before, the several methods used to setup some contexts. In this section, we will see that how these contexts are triggered.</p>
<h5><strong>DPC Execution</strong><span class="hx-absolute -hx-mt-20" id="dpc-execution"></span>
    <a href="#dpc-execution" class="subheading-anchor" aria-label="Permalink for this section"></a></h5><p>The frequently way to trigger a check is to use a DPC. The routine set as DeferredRoutine are picked among the following:</p>
<table>
  <thead>
      <tr>
          <th style="text-align: center"><strong>0</strong></th>
          <th style="text-align: center">CmpEnableLazyFlushDpcRoutine</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center"><strong>1</strong></td>
          <td style="text-align: center">ExpCenturyDpcRoutine</td>
      </tr>
      <tr>
          <td style="text-align: center"><strong>2</strong></td>
          <td style="text-align: center">ExpTimeZoneDpcRoutine</td>
      </tr>
      <tr>
          <td style="text-align: center"><strong>3</strong></td>
          <td style="text-align: center">ExpTimeRefreshDpcRoutine</td>
      </tr>
      <tr>
          <td style="text-align: center"><strong>4</strong></td>
          <td style="text-align: center">CmpLazyFlushDpcRoutine</td>
      </tr>
      <tr>
          <td style="text-align: center"><strong>5</strong></td>
          <td style="text-align: center">ExpTimerDpcRoutine</td>
      </tr>
      <tr>
          <td style="text-align: center"><strong>6</strong></td>
          <td style="text-align: center">IopTimerDispatch</td>
      </tr>
      <tr>
          <td style="text-align: center"><strong>7</strong></td>
          <td style="text-align: center">IopIrpStackProfilerDpcRoutine</td>
      </tr>
      <tr>
          <td style="text-align: center"><strong>8</strong></td>
          <td style="text-align: center">KiBalanceSetManagerDeferredRoutine</td>
      </tr>
      <tr>
          <td style="text-align: center"><strong>9</strong></td>
          <td style="text-align: center">PopThermalZoneDpc</td>
      </tr>
      <tr>
          <td style="text-align: center"><strong>10</strong></td>
          <td style="text-align: center">KiTimerDispatch OR KiDpcDispatch</td>
      </tr>
      <tr>
          <td style="text-align: center"><strong>11</strong></td>
          <td style="text-align: center">KiTimerDispatch OR KiDpcDispatch</td>
      </tr>
      <tr>
          <td style="text-align: center"><strong>12</strong></td>
          <td style="text-align: center">KiTimerDispatch OR KiDpcDispatch</td>
      </tr>
  </tbody>
</table>
<p>Among index 0 to 9, functions use an exception handler to fire the check. KiTimerDispatch and KiDpcDispatch functions call the DPC directly without any exception handler. In other words, these functions do their job while PatchGuard hijacks them to hiding itself.</p>
<h6><strong>Non-Canonical DeferredContext Pointer</strong><span class="hx-absolute -hx-mt-20" id="non-canonical-deferredcontext-pointer"></span>
    <a href="#non-canonical-deferredcontext-pointer" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p>The first objective is to determine whether or not the DPC stacked is a PatchGuard DPC or a usual DPC when one of these pointers is called. All of these function take a DPC structure pointer as parameter and it will be used to determine if the DPC comes from PatchGuard or not.</p>
<p>Also there is cunning. In x64 systems, the memory managements must obey certain rules, in PatchGuard case, it itself is breaking the rule. In the normal case, the addresses are seen like below:</p>
<ul>
<li><strong>Canonical (Normal)</strong>: 0xFFFF803C98DABD1 (With 0xFFF)</li>
<li><strong>Non-Canonical (Anormal)</strong>: 0x803C98DABD1 (Without 0xFFF)</li>
</ul>
<p>With breaking the rule, PatchGuard uses exactly Non-Canonical address. So, the checks for the PatchGuard DPC are occurs with this non-canonical address.</p>
<p>The check is done regarding the argument <strong>KDPC.DeferredContext</strong>, whether it has a canonical address or not. The check is really simple. Here&rsquo;s an example simple snippet from <strong>ExpCenturyDpcRoutine</strong> at <strong>0x1403556C5</strong>:</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">mov</span> <span class="no">rax</span><span class="p">,</span> <span class="no">rbx</span>
</span></span><span class="line"><span class="cl"><span class="nf">sar</span> <span class="no">rax</span><span class="p">,</span> <span class="mi">2</span><span class="no">Fh</span>
</span></span><span class="line"><span class="cl"><span class="nf">inc</span> <span class="no">rax</span>
</span></span><span class="line"><span class="cl"><span class="nf">cmp</span> <span class="no">rax</span><span class="p">,</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="nf">jbe</span> <span class="no">ContextIsNotPatchGuard</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">mov</span> <span class="no">eax</span><span class="p">,</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="nf">jmp</span> <span class="no">Exit</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">ContextIsNotPatchGuard:</span>
</span></span><span class="line"><span class="cl"><span class="nf">xor</span> <span class="no">eax</span><span class="p">,</span><span class="no">eax</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">Exit:</span>
</span></span><span class="line"><span class="cl"><span class="nf">ret</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>If the DeferredContext paramater, which mentioned above has <strong>non-canoncial address</strong>, KiCustomAccessRoutineX is called. An example from <strong>ExpCenturyDpcRoutine</strong>:</p>
<div style="text-align: center;">
  <img src="/images/PatchGuard/img87.png" style="width: 50%" />
</div>
<p>There are KiCustomAccessRoutine functions between 0 to 9. Each function calls KiCustomRecurseRoutineX (Again between 0 to 9) which corresponds to  KiCustomAccessRoutine function. Now we will see these function in next header.</p>
<br>
<h6><strong>Triggering the Exception Handler</strong><span class="hx-absolute -hx-mt-20" id="triggering-the-exception-handler"></span>
    <a href="#triggering-the-exception-handler" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p>Like i said, a KiCustomAccessRoutineX function calls KiCustomRecurseRoutineX function with two parameters: <strong>a counter</strong> and <strong>the non-canonical DeferredContex</strong>. The counter is obtained from the last two bits from the deferred context and plus one.</p>
<p>These KiCustomRecurseRoutineX functions doing simple task in a circle: Decrementing counter and call the next function until the counter is zero.  Here&rsquo;s a diagram:</p>
<div style="text-align: center;">
  <img src="/images/PatchGuard/checkdiagram.png" style="width: 80%" />
</div>
<p>The counter, which given to KiCustomAccessRoutineX decreases in KiCustomRecurseRoutineX function. An example from <strong>KiCustomRecurseRoutine0</strong>:</p>
<div style="text-align: center;">
  <img src="/images/PatchGuard/img88.png" style="width: 40%" />
</div>
<p>Or A Pseudocode:</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">counter</span> <span class="o">=</span> <span class="p">(</span><span class="n">DeferredContext</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">KiCustomRecurseRoutine0</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">	<span class="c1">// BOOM! 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="mh">0xDEADBEEF</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">	<span class="nf">KiCustomRecurseRoutine1</span><span class="p">(</span><span class="n">count</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">KiCustomRecurseRoutine1</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">	<span class="c1">// BOOM! 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="mh">0xDEADBEEF</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">	<span class="nf">KiCustomRecurseRoutine2</span><span class="p">(</span><span class="n">count</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>Until the counter is zero, another KiCustomRecurseRoutineX is called. The idea is that PatchGuard will keep decrementing it and eventually, an invalid pointer will be dereferenced. Depending of each original function, a combination of try/except/finally handler will eventually lead to the decryption of the PatchGuard Context Structure.</p>
<br>
<h6><strong>PatchGuard Context Decryption</strong><span class="hx-absolute -hx-mt-20" id="patchguard-context-decryption"></span>
    <a href="#patchguard-context-decryption" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p>The Exception handler is responsible for decrypting the first layer of the PatchGuard Context Structure. Essentially there are two roughly two layer of decryption:</p>
<ul>
<li><strong>First Layer</strong></li>
</ul>
<p>The first layer of decryption focuses on the whole context structure. There are multiple different code to do so which is summarized in the following list:</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left"><strong>Index</strong></th>
          <th style="text-align: left"><strong>Routine</strong></th>
          <th style="text-align: left"><strong>Layer Encryption</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><strong>0</strong></td>
          <td style="text-align: left">CmpEnableLazyFlushDpcRoutine</td>
          <td style="text-align: left">Method 1</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>1</strong></td>
          <td style="text-align: left">ExpCenturyDpcRoutine</td>
          <td style="text-align: left">Method 1</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>2</strong></td>
          <td style="text-align: left">ExpTimeZoneDpcRoutine</td>
          <td style="text-align: left">Method 1</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>3</strong></td>
          <td style="text-align: left">ExpTimeRefreshDpcRoutine</td>
          <td style="text-align: left">Method 2</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>4</strong></td>
          <td style="text-align: left">CmpEnableLazyFlushDpcRoutine</td>
          <td style="text-align: left">Method 1</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>5</strong></td>
          <td style="text-align: left">ExpTimerDpcRoutine</td>
          <td style="text-align: left">Method 2</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>6</strong></td>
          <td style="text-align: left">IopTimerDispatch</td>
          <td style="text-align: left">Method 2</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>7</strong></td>
          <td style="text-align: left">IopIrpStackProfilerDpcRoutine</td>
          <td style="text-align: left">Method 1</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>8</strong></td>
          <td style="text-align: left">KiBalanceSetManagerDeferredRoutine</td>
          <td style="text-align: left">Method 1</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>9</strong></td>
          <td style="text-align: left">PopThermalZoneDpc</td>
          <td style="text-align: left">Method 2</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>10-12</strong></td>
          <td style="text-align: left">KiTimerDispatch</td>
          <td style="text-align: left">Method 1 + hardcoded key</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>10-12</strong></td>
          <td style="text-align: left">KiDpcDispatch</td>
          <td style="text-align: left">No 1st layer encryption</td>
      </tr>
  </tbody>
</table>
<p>These encryption/decryption routines use random values from KiWaitNever and KiWaitAlways. These global variables holding random values, generated at boot time and used by KiInitPatchGuardContext to encrypt the PatchGuard Context Structure. You can check an example at <strong>0x1406C8E10</strong> address of PopThermalZoneDpc function. Also, don&rsquo;t remember that an attacker which want to interact with the structure can also use these global variables.</p>
<br>
<ul>
<li><strong>Before Second Layer: First Layer (With a Half)</strong></li>
</ul>
<p>Before applying the second layer of decryption, PatchGuard rewrites four bytes at beginning of the context structure.  Ironically, these bytes represent the code that will decrypt the context structure. For instance, we can see it at <strong>0x1406C587C</strong> of ExpCenturyDpcRoutine:</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">mov</span> <span class="no">byte</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">r11</span><span class="p">],</span> <span class="mi">2</span><span class="no">Eh</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span> <span class="no">byte</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">r11</span><span class="err">+</span><span class="mi">1</span><span class="p">],</span> <span class="mi">48</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span> <span class="no">byte</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">r11</span><span class="err">+</span><span class="mi">2</span><span class="p">],</span> <span class="mi">31</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span> <span class="no">byte</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">r11</span><span class="err">+</span><span class="mi">3</span><span class="p">],</span> <span class="mi">11</span><span class="no">h</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>Also at <strong>0x1406C9064</strong> (PopThermalZoneDpc), it uses xor with two hardcoded values:</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="o">*</span><span class="n">PatchGuardCtx</span> <span class="o">=</span> <span class="mh">0xAD1B6FF5</span> <span class="o">^</span> <span class="mh">0xBC2A27DB</span><span class="p">;</span> <span class="p">;</span> <span class="n">Result</span> <span class="o">=</span> <span class="mh">0x1131482E</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>In ExpTimeZoneDpcRoutine, it rewrites directly a DWORD32 and rotate it (0x1406C9508):</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span><span class="err">+</span><span class="mi">38</span><span class="no">h</span><span class="p">],</span> <span class="mi">31482</span><span class="no">E11h</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="no">rdx</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp</span><span class="err">+</span><span class="mi">38</span><span class="no">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">shl</span>     <span class="no">edx</span><span class="p">,</span> <span class="mi">18</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="no">rcx</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp</span><span class="err">+</span><span class="mi">38</span><span class="no">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">shr</span>     <span class="no">rcx</span><span class="p">,</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl"><span class="nf">or</span>      <span class="no">rcx</span><span class="p">,</span> <span class="no">rdx</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="p">[</span><span class="no">rbp</span><span class="err">+</span><span class="mi">38</span><span class="no">h</span><span class="p">],</span> <span class="no">rcx</span> <span class="c1">; 0x1131482E
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">mov</span>     <span class="no">rax</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp</span><span class="err">+</span><span class="mi">38</span><span class="no">h</span><span class="p">]</span> 
</span></span><span class="line"><span class="cl"><span class="no">mov</span>     <span class="p">[</span><span class="no">r11</span><span class="p">],</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">; Call 0x1131482E
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">xor</span>     <span class="no">r9d</span><span class="p">,</span> <span class="no">r9d</span>
</span></span><span class="line"><span class="cl"><span class="nf">xor</span>     <span class="no">r8d</span><span class="p">,</span> <span class="no">r8d</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="no">rdx</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp</span><span class="err">+</span><span class="mi">40</span><span class="no">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="no">rcx</span><span class="p">,</span> <span class="no">r11</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="no">rax</span><span class="p">,</span> <span class="no">r11</span>
</span></span><span class="line"><span class="cl"><span class="nf">call</span>    <span class="no">_guard_dispatch_icall_no_overrides</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>At this point, the usage of XOR is typical of Just-In-Time code, and since the code around is not very clear this is a possibility. Otherwise, these &ldquo;tricks&rdquo; were introduced volontarely to prevent some magic values to be searchable in the code, but it doesn&rsquo;t sound like something difficult to overcome.</p>
<br>
<ul>
<li><strong>Second Layer</strong></li>
</ul>
<p>This layer is relevant to CmpAppendDllSection. Remember this function from <strong>First Section of PatchGuard Context Structure</strong>. The First section of the structure holds the codes of CmpAppendDllSection. The function is called directly at the end of the previous decryption layer called.</p>
<p>Essentially this function has two parts. One of them is that it rewrites its own instruction and decrypt the very next instruction:</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">CmpAppendDllSection</span> <span class="no">proc</span> <span class="no">near</span>
</span></span><span class="line"><span class="cl"><span class="c1">; Rcx points to address which is current instruction
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">xor</span> <span class="p">[</span><span class="no">rcx</span><span class="p">],</span> <span class="no">rdx</span>
</span></span><span class="line"><span class="cl"><span class="nf">xor</span> <span class="p">[</span><span class="no">rcx</span><span class="err">+</span><span class="mi">8</span><span class="p">],</span> <span class="no">rdx</span>
</span></span><span class="line"><span class="cl"><span class="nf">xor</span> <span class="p">[</span><span class="no">rcx</span><span class="err">+</span><span class="mi">10</span><span class="no">h</span><span class="p">],</span> <span class="no">rdx</span>
</span></span><span class="line"><span class="cl"><span class="nf">xor</span> <span class="p">[</span><span class="no">rcx</span><span class="err">+</span><span class="mi">18</span><span class="no">h</span><span class="p">],</span> <span class="no">rdx</span>
</span></span><span class="line"><span class="cl"><span class="nf">xor</span> <span class="p">[</span><span class="no">rcx</span><span class="err">+</span><span class="mi">20</span><span class="no">h</span><span class="p">],</span> <span class="no">rdx</span>
</span></span><span class="line"><span class="cl"><span class="nf">xor</span> <span class="p">[</span><span class="no">rcx</span><span class="err">+</span><span class="mi">28</span><span class="no">h</span><span class="p">],</span> <span class="no">rdx</span>
</span></span><span class="line"><span class="cl"><span class="nf">xor</span> <span class="p">[</span><span class="no">rcx</span><span class="err">+</span><span class="mi">30</span><span class="no">h</span><span class="p">],</span> <span class="no">rdx</span>
</span></span><span class="line"><span class="cl"><span class="nf">xor</span> <span class="p">[</span><span class="no">rcx</span><span class="err">+</span><span class="mi">38</span><span class="no">h</span><span class="p">],</span> <span class="no">rdx</span>
</span></span><span class="line"><span class="cl"><span class="na">...</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>And last part is relevant to decryption loop for the whole context structure:</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">loc_140BFC65F:</span>
</span></span><span class="line"><span class="cl"><span class="nf">xor</span> <span class="p">[</span><span class="no">rdx</span><span class="err">+</span><span class="no">rcx</span><span class="p">*</span><span class="mi">8</span><span class="err">+</span><span class="mi">0</span><span class="no">C0h</span><span class="p">],</span> <span class="no">rax</span>
</span></span><span class="line"><span class="cl"><span class="nf">ror</span> <span class="no">rax</span><span class="p">,</span> <span class="no">cl</span>
</span></span><span class="line"><span class="cl"><span class="nf">btc</span> <span class="no">rax</span><span class="p">,</span> <span class="no">rax</span>
</span></span><span class="line"><span class="cl"><span class="nf">loop</span> <span class="no">loc_140BFC65F</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>And then, the context structure will be ready to use.
<br></p>
<h6><strong>Passing Control to Verification Routine</strong><span class="hx-absolute -hx-mt-20" id="passing-control-to-verification-routine"></span>
    <a href="#passing-control-to-verification-routine" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p>After the decryption, two functions are called after that. The first function is called directly from the structure. ThÄ±s function is a copy of <strong>sub_140BCADF0</strong> function. This function does two things:</p>
<ul>
<li><strong>Verify the integrity of the PatchGuard Context structure and 47 Routines</strong></li>
</ul>
<p>Its mainly job is that verify the integrity of the structure and 47 routines. For instance, the first code to be checked is the epilogue of ExpWorkerThread calling KeBugCheckEx at <strong>0x1402C375B</strong>:</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">loc_1402C375B:</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="no">r9</span><span class="p">,</span> <span class="no">rsi</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">78</span><span class="no">h</span><span class="err">+</span><span class="no">BugCheckParameter4</span><span class="p">],</span> <span class="mi">0</span><span class="no">FFFFFFFFFFFFFFFFh</span> <span class="c1">; BugCheckParameter4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">mov</span>     <span class="no">r8</span><span class="p">,</span> <span class="no">r15</span>         <span class="c1">; BugCheckParameter2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">mov</span>     <span class="no">edx</span><span class="p">,</span> <span class="mi">5</span>          <span class="c1">; BugCheckParameter1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="mi">0</span><span class="no">E4h</span>       <span class="c1">; BugCheckCode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">call</span>    <span class="no">KeBugCheckEx</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>The second check is exception handler of <strong>ExpWorkerThread</strong> and the last check is <strong>KeIpiGenericCall</strong>.</p>
<br>
<ul>
<li><strong>Initialize WORK_QUEUE_ITEM Structure</strong></li>
</ul>
<p>As we can see at <strong>0x140BCBB8C</strong>, it initialize a WORK_QUEUE_ITEM structure:</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">StubIndex</span> <span class="o">=</span> <span class="n">Ctx</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">Ctx</span> <span class="o">+</span> <span class="mi">2064</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">Ctx</span> <span class="o">+</span> <span class="mi">2520</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x8000000</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">GetRandomValue</span> <span class="o">=</span> <span class="nf">__rdtsc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">RotatedValue</span> <span class="o">=</span> <span class="nf">__ROR8__</span><span class="p">(</span><span class="n">GetRandomValue</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span> <span class="c1">// Shift random value 3 bits right
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">HashMix</span> <span class="o">=</span> <span class="p">((</span><span class="n">RotatedValue</span> <span class="o">^</span> <span class="n">GetRandomValue</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x7010008004002001uLL</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">64</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">StubIndex</span> <span class="o">=</span> <span class="n">KiMachineCheckControl</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> <span class="p">(((</span><span class="n">RotatedValue</span> <span class="o">^</span> <span class="n">GetRandomValue</span><span class="p">)</span> <span class="o">^</span> <span class="n">HashMix</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">*</span><span class="p">(</span><span class="n">Ctx</span> <span class="o">+</span> <span class="mi">1992</span><span class="p">)</span> <span class="o">=</span> <span class="n">StubIndex</span><span class="p">;</span> <span class="cm">/* 0x140BCBB8C */</span>
</span></span><span class="line"><span class="cl"><span class="o">*</span><span class="p">(</span><span class="n">Ctx</span> <span class="o">+</span> <span class="mi">2000</span><span class="p">)</span> <span class="o">=</span> <span class="n">v137</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">*</span><span class="p">(</span><span class="n">Ctx</span> <span class="o">+</span> <span class="mi">1976</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>The WorkerRoutine is picked out of three stub that will call a verification routine as a WorkItem. The three stubs are:</p>
<br>
<ol>
<li>As we see previously (check the method 7), a random stub picked from <strong>KiMachineCheckControl</strong> array if the method 7 selected. In this case the field Parameter points to the PatchGuard context.
<br></li>
<li>The copy of FsRtlUninitializeSmallMcb in the PatchGuard context structure. In this case the Parameter is also the PatchGuard context sub_1401812E0, which is only a stub to call the deferred routine from a DPC passed as a parameter.
<br></li>
</ol>
<p>The second call is relevant to <strong>ExQueueWorkItem</strong>. The WORK_QUEUE_ITEM structure which initialized is passed as parameter. We can see it at <strong>0x140520E05</strong> from RtlpComputeEpilogueOffset:</p>
<div style="text-align: center;">
  <img src="/images/PatchGuard/img89.png" style="width: 50%" />
</div>
<p>RtlpComputeEpilogueOffset is called by these functions which relevant to DPC Execution method:</p>
<div style="text-align: center;">
  <img src="/images/PatchGuard/img90.png" style="width: 85%" />
</div>
<p>Notice that it&rsquo;s also called by <strong>FsRtlTruncateSmallMcb</strong> function. In FsRtlTruncateSmallMcb, it is called twice after KiCustomAccessRoutine0 routine (Check <strong>0x1406C9B20</strong> and <strong>0x14068FC7E</strong>).</p>
<h5><strong>System Thread Method</strong><span class="hx-absolute -hx-mt-20" id="system-thread-method"></span>
    <a href="#system-thread-method" class="subheading-anchor" aria-label="Permalink for this section"></a></h5><p>As we discussed before, PatchGuard creates a system thread in method 3. Pg_InitMethod3SystemThread is called directly in KiInitPatchGuardContext.</p>
<h6><strong>Triggering the Exception Handler</strong><span class="hx-absolute -hx-mt-20" id="triggering-the-exception-handler-1"></span>
    <a href="#triggering-the-exception-handler-1" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p>In this  method, PsCreateSystemThread is called via exception handler. Actually, the codes of triggering the exception handler is strange.</p>
<p>We can start our journey with <strong>0x140BD7F02</strong> address. Here, cpuid instruction is executed by KiInitPatchGuardContext:</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">loc_140BD7F02:</span>
</span></span><span class="line"><span class="cl"><span class="nf">sti</span>
</span></span><span class="line"><span class="cl"><span class="nf">xor</span>     <span class="no">ecx</span><span class="p">,</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="mi">80000008</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nf">cpuid</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="no">edi</span><span class="p">,</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nf">shr</span>     <span class="no">edi</span><span class="p">,</span> <span class="mi">8</span>          <span class="c1">; Shift 8 bytes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">mov</span>     <span class="p">[</span><span class="no">r14</span><span class="err">+</span><span class="mi">940</span><span class="no">h</span><span class="p">],</span> <span class="no">dil</span> <span class="err">;</span> <span class="no">Pass</span> <span class="no">the</span> <span class="no">result</span> <span class="no">to</span> <span class="no">the</span> <span class="no">structure.</span> </span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>Firstly, the eax gets <strong>0x80000008</strong> value, then cpuid is executed. After the execution, the result is shifted 8 bytes to the right and the result is passed to 0x940 offset of the structure.</p>
<p>This value 0x80000008 corresponds to <strong>linear/physical address size data</strong>. From Felix Clouiter<sup>[5]</sup>:</p>
<blockquote>
  <p><em>&ldquo;Two types of information are returned: basic and extended function information. If a value entered for CPUID.EAX is higher than the maximum input value for basic or extended function for that processor then the data for the highest basic information leaf is returned. For example, using some Intel processors, the following is true:
&hellip;
CPUID.EAX = 80000008H (</em> Returns linear/physical address size data. <em>)&rdquo;</em></p>
</blockquote>
<p>Then i wanna see the result and i created a driver with MASM Assembly:</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">extern</span> <span class="no">DbgPrintEx</span><span class="p">:</span><span class="no">PROC</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="na">.data</span>
</span></span><span class="line"><span class="cl">	<span class="nf">UnloadedMsg</span> <span class="no">db</span> <span class="err">&#34;</span><span class="no">Driver</span> <span class="no">Unloaded</span><span class="p">!</span><span class="err">&#34;</span><span class="p">,</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="na">.code</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">UnloadDriver</span> <span class="no">PROC</span>
</span></span><span class="line"><span class="cl">	<span class="nf">sub</span> <span class="no">rsp</span><span class="p">,</span><span class="mi">28</span><span class="no">h</span>
</span></span><span class="line"><span class="cl">	<span class="nf">lea</span> <span class="no">r8</span><span class="p">,[</span><span class="no">UnloadedMsg</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="nf">xor</span> <span class="no">rdx</span><span class="p">,</span><span class="no">rdx</span>
</span></span><span class="line"><span class="cl">	<span class="nf">xor</span> <span class="no">rcx</span><span class="p">,</span><span class="no">rcx</span>
</span></span><span class="line"><span class="cl">	<span class="nf">call</span> <span class="no">DbgPrintEx</span>
</span></span><span class="line"><span class="cl">	<span class="nf">add</span> <span class="no">rsp</span><span class="p">,</span><span class="mi">28</span><span class="no">h</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">xor</span> <span class="no">rax</span><span class="p">,</span><span class="no">rax</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ret</span>
</span></span><span class="line"><span class="cl"><span class="nf">UnloadDriver</span> <span class="no">ENDP</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">DriverEntry</span> <span class="no">PROC</span>
</span></span><span class="line"><span class="cl">	<span class="c1">; /* Prepare UnloadDriver */
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">mov</span> <span class="no">rax</span><span class="p">,</span><span class="no">rcx</span>
</span></span><span class="line"><span class="cl">	<span class="nf">lea</span> <span class="no">rcx</span><span class="p">,[</span><span class="no">UnloadDriver</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="nf">mov</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rax</span><span class="err">+</span><span class="mi">68</span><span class="no">h</span><span class="p">],</span><span class="no">rcx</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">mov</span> <span class="no">eax</span><span class="p">,</span><span class="mi">80000008</span><span class="no">h</span>
</span></span><span class="line"><span class="cl">	<span class="nf">cpuid</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">mov</span> <span class="no">edi</span><span class="p">,</span><span class="no">eax</span>
</span></span><span class="line"><span class="cl">	<span class="nf">shr</span> <span class="no">edi</span><span class="p">,</span><span class="mi">8</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">xor</span> <span class="no">rax</span><span class="p">,</span><span class="no">rax</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ret</span>
</span></span><span class="line"><span class="cl"><span class="nf">DriverEntry</span> <span class="no">ENDP</span>
</span></span><span class="line"><span class="cl"><span class="nf">END</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>Here&rsquo;s result:</p>
<div style="text-align: center;">
  <img src="/images/PatchGuard/img91.png" style="width: 60%" />
</div>
<p>the size result is <strong>0x302d</strong>. After the shift process, edi register is taken 0x30 value:</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">kd</span><span class="err">&gt;</span> <span class="no">t</span>
</span></span><span class="line"><span class="cl"><span class="nf">cpuid</span><span class="p">!</span><span class="no">DriverEntry</span><span class="err">+</span><span class="mi">0x17</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="nf">fffff800</span><span class="err">`</span><span class="mi">76591035</span> <span class="no">c1ef08</span>          <span class="no">shr</span>     <span class="no">edi</span><span class="p">,</span><span class="mi">8</span>
</span></span><span class="line"><span class="cl"><span class="nf">kd</span><span class="err">&gt;</span> <span class="no">r</span> <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="nf">edi</span><span class="err">=</span><span class="mi">302</span><span class="no">d</span>
</span></span><span class="line"><span class="cl"><span class="nf">kd</span><span class="err">&gt;</span> <span class="no">t</span>
</span></span><span class="line"><span class="cl"><span class="nf">cpuid</span><span class="p">!</span><span class="no">DriverEntry</span><span class="err">+</span><span class="mi">0x1a</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="nf">fffff800</span><span class="err">`</span><span class="mi">76591038</span> <span class="mi">33</span><span class="no">c0</span>            <span class="no">xor</span>     <span class="no">eax</span><span class="p">,</span><span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nf">kd</span><span class="err">&gt;</span> <span class="no">r</span> <span class="no">edi</span> 
</span></span><span class="line"><span class="cl"><span class="no">edi</span><span class="err">=</span><span class="mi">30</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>So, we can see that <strong>0x940</strong> offset contains 0x30 value.</p>
<p>This value is used at <strong>0x140BFAEAD</strong> to trigger the exception in Pg_InitMethod3SystemThread:</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">loc_140BFAE88:</span>
</span></span><span class="line"><span class="cl"><span class="na">...</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="no">al</span><span class="p">,</span> <span class="p">[</span><span class="no">rsi</span><span class="err">+</span><span class="mi">940</span><span class="no">h</span><span class="p">]</span>  <span class="c1">; Get 0x30
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">dec</span>     <span class="no">al</span>
</span></span><span class="line"><span class="cl"><span class="nf">movzx</span>   <span class="no">r10d</span><span class="p">,</span> <span class="no">al</span>        <span class="c1">; r10d -&gt; 0x2F
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">mov</span>     <span class="no">r11d</span><span class="p">,</span> <span class="mi">3</span><span class="no">Fh</span> <span class="c1">; &#39;?&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">sub</span>     <span class="no">r11d</span><span class="p">,</span> <span class="no">r10d</span>      <span class="c1">; Result: 0x10
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="na">...</span>
</span></span><span class="line"><span class="cl"><span class="nf">div</span>     <span class="no">r11</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>The value is subtracted with <strong>0x3F</strong> value, so that if the maximum virtual address size is 0x3F, then rbx is 0 and the exception will be triggered:</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<pre><code>Breakpoint 0 hit
nt!KiFilterFiberContext&#43;0x29443:
fffff804`a6f5e973 49f7f3          div     rax,r11

kd&gt; r r11
r11=0000000000000010
kd&gt; r r11 = 0 

kd&gt; g
Breakpoint 1 hit
nt!KiFilterFiberContext&#43;0x2949b:
fffff804`a6f5e9cb 803dbf70370000  cmp     byte ptr [nt!KdDebuggerNotPresent (fffff804`a72d5a91)],0</code></pre><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>The div operation triggers the <strong>loc_140BFAF3A</strong> function, then PsCreateSystemThread is called.</p>
<p>Also the value which held in the 0x940 offset is used by <strong>FsRtlMdlReadCompleteDevEx</strong>. I didn&rsquo;t tell about the function through this article but this function is PatchGuard routine and contains really long codes. Seems like this value is used with the same purpose at <strong>0x140BC462C</strong>:</p>
<div style="text-align: center;">
  <img src="/images/PatchGuard/img92.png" style="width: 75%" />
</div>
<p>These registers which used for the math is prepared at <strong>0x140BC45B8</strong>:</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">loc_140BC45B8:</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="no">r13d</span><span class="p">,</span> <span class="mi">28</span><span class="no">h</span> <span class="c1">; &#39;(&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">lea</span>     <span class="no">rcx</span><span class="p">,</span> <span class="p">[</span><span class="no">r12</span><span class="err">+</span><span class="mi">918</span><span class="no">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="no">r8d</span><span class="p">,</span> <span class="no">r13d</span>
</span></span><span class="line"><span class="cl"><span class="nf">lea</span>     <span class="no">rdx</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp</span><span class="err">+</span><span class="mi">8</span><span class="no">D0h</span><span class="err">+</span><span class="no">var_668</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">lea</span>     <span class="no">r9d</span><span class="p">,</span> <span class="p">[</span><span class="no">r13-23h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">lea</span>     <span class="no">r10d</span><span class="p">,</span> <span class="p">[</span><span class="no">r13-27h</span><span class="p">]</span> <span class="err">;</span> <span class="no">R10D</span><span class="p">:</span> <span class="mi">0x1</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>But i wasn&rsquo;t sure where it was directed.</p>
<h6><strong>Creating New Thread</strong><span class="hx-absolute -hx-mt-20" id="creating-new-thread"></span>
    <a href="#creating-new-thread" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p>The System Thread is created at <strong>0x140BFAF46</strong> address:</p>
<div style="text-align: center;">
  <img src="/images/PatchGuard/img94.png" style="width: 75%" />
</div>
<p>Recall that the structure KI_FILTER_FIBER_PARAM contains the pointer of PsCreateSystemThread and used by PatchGuard. The StartContext parameter given to PsCreateSystemThread is a pointer to a new type of structure which can be defined as follow:</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">pg_StartContext</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">ULONG64</span> <span class="n">Event</span><span class="p">;</span> <span class="n">Just</span> <span class="n">a</span> <span class="n">pointer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">event</span> <span class="n">in</span> <span class="n">the</span> <span class="n">very</span>
</span></span><span class="line"><span class="cl">	<span class="p">;</span> <span class="p">...</span> <span class="n">same</span> <span class="n">structure</span>
</span></span><span class="line"><span class="cl">	<span class="n">ULONG64</span> <span class="n">Random_ShouldRunKeRundownApcQueues</span><span class="p">;</span> <span class="n">set</span> <span class="n">at</span> <span class="mh">0x140BFAE17</span>
</span></span><span class="line"><span class="cl">	<span class="n">ULONG64</span> <span class="n">unknown_0x10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">KEVENT_</span> <span class="n">Event</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p><strong>The Even Object</strong> is initialized before the exception handler, and in <strong>sub_14068F650</strong> function, KeWaitForSingleObject is waiting on this object to be signaled at <strong>0x14068F6F3</strong>:</p>
<div style="text-align: center;">
  <img src="/images/PatchGuard/img93.png" style="width: 48%" />
</div>
<p>This event is notified at the end of the KiInitPatchGuardContext. Also note that there is no timeout (set to 0) for the first time this method is used. Function Pg_InitMethodSystemThread returns a pointer to the structure and the event is notified at the end of KiInitPatchGuardContext at <strong>0x140BF9E3F</strong>:</p>
<div style="text-align: center;">
  <img src="/images/PatchGuard/img95.png" style="width: 60%" />
</div>
<p>Then the decryption process will be started.</p>
<h6><strong>The Decryption Process</strong><span class="hx-absolute -hx-mt-20" id="the-decryption-process"></span>
    <a href="#the-decryption-process" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p>The decryption process is basically the same as the one used by DPCs: a two stages decryption with an additional hard-coded prologue. The first stage uses KiWaitNever and KiWaitAlways and the second stage is performed by CmpAppendDllSection&rsquo;s copy, just like in the DPC case, which eventually calls the verification routine.</p>
<h6><strong>Post verification for this case only</strong><span class="hx-absolute -hx-mt-20" id="post-verification-for-this-case-only"></span>
    <a href="#post-verification-for-this-case-only" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p>Once the verification routine ended, the context is restored to a waiting state with either
KeDelayExecutionThread or KeWaitForSingleObject, but this time with a timeout set between 2&rsquo; and 2'10&quot;. From FsRtlMdlReadCompleteDevEx:</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">loc_140BC26F1:</span>
</span></span><span class="line"><span class="cl">	<span class="na">...</span>
</span></span><span class="line"><span class="cl">	<span class="nf">mov</span> <span class="no">r10</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp</span><span class="err">+</span><span class="mi">8</span><span class="no">D0h</span><span class="err">+</span><span class="no">arg_8</span><span class="p">]</span> <span class="c1">; Get Timeout
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="na">...</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">loc_140BC274A:</span>
</span></span><span class="line"><span class="cl">	<span class="nf">mov</span> <span class="no">r9</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp</span><span class="err">+</span><span class="mi">8</span><span class="no">D0h</span><span class="err">+</span><span class="no">var_950</span><span class="p">]</span> <span class="c1">; Get the address of KeDelayExecutionThread
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="nl">loc_140BC274E:</span>
</span></span><span class="line"><span class="cl">	<span class="nf">test</span> <span class="no">r10</span><span class="p">,</span> <span class="no">r10</span> <span class="c1">; If the timeout is 0, then execute KeDelayExecutionThread
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">jz</span> <span class="no">short</span> <span class="no">loc_140BC2770</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">; Call KeWaitForSingleObject
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">mov</span> <span class="no">rax</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp</span><span class="err">+</span><span class="mi">8</span><span class="no">D0h</span><span class="err">+</span><span class="no">var_8F0</span><span class="p">]</span> <span class="c1">; Get the address of the function
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">lea</span> <span class="no">r8</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp</span><span class="err">+</span><span class="mi">8</span><span class="no">D0h</span><span class="err">+</span><span class="no">var_850</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="nf">mov</span> <span class="no">edx</span><span class="p">,</span> <span class="no">r14d</span>
</span></span><span class="line"><span class="cl">	<span class="nf">mov</span> <span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">9</span><span class="no">D0h</span><span class="err">+</span><span class="no">BugCheckParameter4</span><span class="p">],</span> <span class="no">r10</span> <span class="c1">; Pass the timeout
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">mov</span> <span class="no">rcx</span><span class="p">,</span> <span class="no">rsi</span>
</span></span><span class="line"><span class="cl">	<span class="nf">call</span> <span class="no">KeGuardDispatchICall</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">loc_140BC2770:</span>
</span></span><span class="line"><span class="cl">	<span class="c1">; Call KeDelayExecutionThread
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">xor</span> <span class="no">edx</span><span class="p">,</span> <span class="no">edx</span>
</span></span><span class="line"><span class="cl">	<span class="nf">test</span> <span class="no">r11</span><span class="p">,</span> <span class="no">r11</span>
</span></span><span class="line"><span class="cl">	<span class="nf">jnz</span> <span class="no">short</span> <span class="no">loc_140BC278A</span>
</span></span><span class="line"><span class="cl">	<span class="nf">lea</span> <span class="no">r8</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp</span><span class="err">+</span><span class="mi">8</span><span class="no">D0h</span><span class="err">+</span><span class="no">var_850</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="nf">xor</span> <span class="no">ecx</span><span class="p">,</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl">	<span class="nf">mov</span> <span class="no">rax</span><span class="p">,</span> <span class="no">r9</span> <span class="c1">; Pass the address KeDelayExecutionThread to rax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">call</span> <span class="no">KeGuardDispatchICall</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>The timeout is initialized at <strong>0x140BC24E1</strong>:</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">loc_140BC24E1:</span>
</span></span><span class="line"><span class="cl"><span class="na">...</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span> <span class="no">r10</span><span class="p">,</span> <span class="p">[</span><span class="no">rsi</span><span class="err">+</span><span class="mi">0</span><span class="no">AB8h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span> <span class="no">ecx</span><span class="p">,</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span> <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">rsi</span><span class="err">+</span><span class="mi">9</span><span class="no">DCh</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span> <span class="no">r14d</span><span class="p">,</span> <span class="p">[</span><span class="no">rsi</span><span class="err">+</span><span class="mi">804</span><span class="no">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span> <span class="no">r11</span><span class="p">,</span> <span class="p">[</span><span class="no">rsi</span><span class="err">+</span><span class="mi">0</span><span class="no">A40h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span> <span class="no">r12d</span><span class="p">,</span> <span class="p">[</span><span class="no">rsi</span><span class="err">+</span><span class="mi">828</span><span class="no">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span> <span class="p">[</span><span class="no">rbp</span><span class="err">+</span><span class="mi">8</span><span class="no">D0h</span><span class="err">+</span><span class="no">arg_8</span><span class="p">],</span> <span class="no">r10</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>Also these functions address are initialized at <strong>0x140BC252F</strong>, and the variables which used for the functions are prepared randomly at the same address:</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">loc_140BC252F:</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span> <span class="no">rax</span><span class="p">,</span> <span class="p">[</span><span class="no">rsi</span><span class="err">+</span><span class="mi">2</span><span class="no">C8h</span><span class="p">]</span> <span class="c1">; Get the Address of KeWaitForSingleObject
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">mov</span> <span class="no">r9</span><span class="p">,</span> <span class="p">[</span><span class="no">rsi</span><span class="err">+</span><span class="mi">170</span><span class="no">h</span><span class="p">]</span>  <span class="c1">; Get the address of KeDelayExecutionThread
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">mov</span> <span class="p">[</span><span class="no">rbp</span><span class="err">+</span><span class="mi">8</span><span class="no">D0h</span><span class="err">+</span><span class="no">var_8D8</span><span class="p">],</span> <span class="no">rax</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span> <span class="no">rax</span><span class="p">,</span> <span class="p">[</span><span class="no">rsi</span><span class="err">+</span><span class="mi">340</span><span class="no">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span> <span class="p">[</span><span class="no">rbp</span><span class="err">+</span><span class="mi">8</span><span class="no">D0h</span><span class="err">+</span><span class="no">var_8F0</span><span class="p">],</span> <span class="no">rax</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span> <span class="p">[</span><span class="no">rbp</span><span class="err">+</span><span class="mi">8</span><span class="no">D0h</span><span class="err">+</span><span class="no">var_950</span><span class="p">],</span> <span class="no">r9</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<h5><strong>APC insertion</strong><span class="hx-absolute -hx-mt-20" id="apc-insertion"></span>
    <a href="#apc-insertion" class="subheading-anchor" aria-label="Permalink for this section"></a></h5><p>As we saw previously, the fourth method insert an APC in system thread queue. The system thread must have the pointer of <strong>PopIrpWorkerControl</strong> as a StartAddress Parameter. From <strong>0x140BFB2AF</strong>:</p>
<div style="text-align: center;">
  <img src="/images/PatchGuard/img96.png" style="width: 60%" />
</div>
<p>Also recall that The KernelRoutine parameter which given to KiInsertQueueApc is <strong>KiDispatchCallout</strong>.</p>
<p>Similar to the DPC and system thread methods, this method uses a two-stage decryption process and rewrites the beginning of the context with a fixed XOR value. This approach is quite fast because APCs are delivered quickly. However, unlike the previous methods, it waits during verification to make sure a minimum time has passedâ€”between 2 minutes and 2 minutes 10 secondsâ€”before continuing.</p>
<h5><strong>KiSwInterruptDispatch Method</strong><span class="hx-absolute -hx-mt-20" id="kiswinterruptdispatch-method"></span>
    <a href="#kiswinterruptdispatch-method" class="subheading-anchor" aria-label="Permalink for this section"></a></h5><p>This method uses the Global PatchGuard Context Structure, which is in cleartext. This means that there is no decryption process and the verification routine is called directly at some point in KiSwInterrupt.</p>
<h5><strong>Breadcrumbs</strong><span class="hx-absolute -hx-mt-20" id="breadcrumbs"></span>
    <a href="#breadcrumbs" class="subheading-anchor" aria-label="Permalink for this section"></a></h5><p>Breadcrumbs methods are special because <strong>they work automatically without specific code to start their checks.</strong> However, they do not run all the time. For instance, recall CcInitializeBcbProfiler. It either queues a work item using a related function or continues running on its own. The other two verification functions, PspProcessDelete and KiInitializeUserApc, only use a simple timer (just a time counter stored in a global variable, not the TIMER structure) to control when they run.</p>

        </div>
        
    <div class="hx-mt-12 hx-mb-8 hx-block hx-text-xs hx-text-gray-500 ltr:hx-text-right rtl:hx-text-left dark:hx-text-gray-400">Last updated on <time datetime="2025-08-16T00:35:41.000Z">August 16, 2025</time></div>
        
        <div class="hx-mb-8 hx-flex hx-items-center hx-border-t hx-pt-8 dark:hx-border-neutral-800 contrast-more:hx-border-neutral-400 dark:contrast-more:hx-border-neutral-400 print:hx-hidden"><a
        href="/blog/patchguard-analysis-part-2/"
        title="PatchGuard Analysis - Part 2"
        class="hx-flex hx-max-w-[50%] hx-items-center hx-gap-1 hx-py-4 hx-text-base hx-font-medium hx-text-gray-600 hx-transition-colors [word-break:break-word] hover:hx-text-primary-600 dark:hx-text-gray-300 md:hx-text-lg ltr:hx-pr-4 rtl:hx-pl-4"
      ><svg class="hx-inline hx-h-5 hx-shrink-0 ltr:hx-rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>PatchGuard Analysis - Part 2</a><a
        href="/blog/patchguard-analysis-part-4/"
        title="PatchGuard Analysis - Part 4"
        class="hx-flex hx-max-w-[50%] hx-items-center hx-gap-1 hx-py-4 hx-text-base hx-font-medium hx-text-gray-600 hx-transition-colors [word-break:break-word] hover:hx-text-primary-600 dark:hx-text-gray-300 md:hx-text-lg ltr:hx-ml-auto ltr:hx-pl-4 ltr:hx-text-right rtl:hx-mr-auto rtl:hx-pr-4 rtl:hx-text-left"
      >PatchGuard Analysis - Part 4<svg class="hx-inline hx-h-5 hx-shrink-0 rtl:-hx-rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg></a></div>
        
      </main>
    </article>
  </div>

      <footer class="hextra-footer hx-bg-gray-100 hx-pb-[env(safe-area-inset-bottom)] dark:hx-bg-neutral-900 print:hx-bg-transparent"><div class="hx-mx-auto hx-flex hx-gap-2 hx-py-2 hx-px-4 hx-max-w-screen-xl"><div class="hx-flex hx-justify-items-start ">
    <button
      title="Change language"
      data-state="closed"
      class="language-switcher hx-h-7 hx-rounded-md hx-px-2 hx-text-left hx-text-xs hx-font-medium hx-text-gray-600 hx-transition-colors dark:hx-text-gray-400 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 hx-grow"
      type="button"
      aria-label="Change language"
    >
      <div class="hx-flex hx-items-center hx-gap-2 hx-capitalize"><svg height=12 xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/></svg><span>English</span></div>
    </button>
    <ul
      class="language-options hx-hidden hx-z-20 hx-max-h-64 hx-overflow-auto hx-rounded-md hx-ring-1 hx-ring-black/5 hx-bg-white hx-py-1 hx-text-sm hx-shadow-lg dark:hx-ring-white/20 dark:hx-bg-neutral-800"
      style="position: fixed; inset: auto auto 0px 0px; margin: 0px; min-width: 100px;"
    >
      
        
        <li class="hx-flex hx-flex-col">
          <a
            href="/blog/patchguard-analysis-part-3/"
            class="hx-text-gray-800 dark:hx-text-gray-100 hover:hx-bg-primary-50 hover:hx-text-primary-600 hover:dark:hx-bg-primary-500/10 hover:dark:hx-text-primary-600 hx-relative hx-cursor-pointer hx-whitespace-nowrap hx-py-1.5 hx-transition-colors ltr:hx-pl-3 ltr:hx-pr-9 rtl:hx-pr-3 rtl:hx-pl-9"
          >English<span class="hx-absolute hx-inset-y-0 hx-flex hx-items-center ltr:hx-right-3 rtl:hx-left-3"><svg height=1em width=1em xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg></span></a>
        </li>
      
        
        <li class="hx-flex hx-flex-col">
          <a
            href="/tr/blog/patchguard-analysis-part-3/"
            class="hx-text-gray-800 dark:hx-text-gray-100 hover:hx-bg-primary-50 hover:hx-text-primary-600 hover:dark:hx-bg-primary-500/10 hover:dark:hx-text-primary-600 hx-relative hx-cursor-pointer hx-whitespace-nowrap hx-py-1.5 hx-transition-colors ltr:hx-pl-3 ltr:hx-pr-9 rtl:hx-pr-3 rtl:hx-pl-9"
          >Turkish</a>
        </li>
      </ul>
  </div><button
  title="Change theme"
  data-theme="light"
  class="theme-toggle hx-group hx-h-7 hx-rounded-md hx-px-2 hx-text-left hx-text-xs hx-font-medium hx-text-gray-600 hx-transition-colors dark:hx-text-gray-400 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50"
  type="button"
  aria-label="Change theme"
>
  <div class="hx-flex hx-items-center hx-gap-2 hx-capitalize"><svg height=12 class="group-data-[theme=light]:hx-hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg><span class="group-data-[theme=light]:hx-hidden">Light</span><svg height=12 class="group-data-[theme=dark]:hx-hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg><span class="group-data-[theme=dark]:hx-hidden">Dark</span></div>
</button>
</div><hr class="dark:hx-border-neutral-800" /><div
      class="hextra-custom-footer hx-max-w-screen-xl hx-pl-[max(env(safe-area-inset-left),1.5rem)] hx-pr-[max(env(safe-area-inset-right),1.5rem)] hx-text-gray-600 dark:hx-text-gray-400"
    ></div><div
        class="hx-max-w-screen-xl hx-mx-auto hx-flex hx-justify-center hx-py-12 hx-pl-[max(env(safe-area-inset-left),1.5rem)] hx-pr-[max(env(safe-area-inset-right),1.5rem)] hx-text-gray-600 dark:hx-text-gray-400 md:hx-justify-start"
      >
        <div class="hx-flex hx-w-full hx-flex-col hx-items-center sm:hx-items-start"><div class="hx-font-semibold"><a class="hx-flex hx-text-sm hx-items-center hx-gap-1 hx-text-current" target="_blank" rel="noopener noreferrer" title="Hextra GitHub Homepage" href="https://github.com/imfing/hextra">
    <span>Powered by Hextra<svg height=1em class="hx-inline-block ltr:hx-ml-1 rtl:hx-mr-1 hx-align-[-2.5px]" viewBox="0 0 180 180" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><path fill-rule="evenodd" clip-rule="evenodd" d="m 105.50024,22.224647 c -9.59169,-5.537563 -21.40871,-5.537563 -31.000093,0 L 39.054693,42.689119 C 29.463353,48.226675 23.55484,58.460531 23.55484,69.535642 v 40.928918 c 0,11.07542 5.908513,21.3092 15.499853,26.84652 l 35.445453,20.46446 c 9.591313,5.53732 21.408404,5.53732 31.000094,0 l 35.44507,-20.46446 c 9.59131,-5.53732 15.49985,-15.7711 15.49985,-26.84652 V 69.535642 c 0,-11.075111 -5.90854,-21.308967 -15.49985,-26.846523 z M 34.112797,85.737639 c -1.384445,2.397827 -1.384445,5.352099 0,7.749927 l 24.781554,42.922974 c 1.38437,2.39783 3.942853,3.87496 6.711592,3.87496 h 49.563107 c 2.76905,0 5.3273,-1.47713 6.71144,-3.87496 l 24.78194,-42.922974 c 1.38414,-2.397828 1.38414,-5.3521 0,-7.749927 L 121.88049,42.814746 c -1.38414,-2.397828 -3.94239,-3.874964 -6.71144,-3.874964 H 65.605944 c -2.768739,0 -5.327223,1.477059 -6.711592,3.874964 z" style="stroke-width:0.774993" /></svg></span>
  </a></div><div class="hx-mt-6 hx-text-xs">Â© 2024 Hextra Project.</div></div>
      </div></footer>
    
    <script defer src="/js/main.js" integrity=""></script>


<script defer src="/lib/flexsearch/flexsearch.bundle.min.0425860527cc9968f9f049421c7a56b39327d475e2e3a8f550416be3a9134327.js" integrity="sha256-BCWGBSfMmWj58ElCHHpWs5Mn1HXi46j1UEFr46kTQyc="></script>
    <script defer src="/en.search.js" integrity=""></script>


  </body>
</html>
